<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام ملعبي - المنصة المتكاملة لجميع الرياضات</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- 添加PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=YOUR_SANDBOX_CLIENT_ID&currency=SAR"></script>
<style>
/* --- Global Variables & Resets --- */
:root {
--primary-color: #3498db;
--secondary-color: #2ecc71;
--accent-color: #e74c3c;
--light-bg: #f0f2f5;
--card-bg: #ffffff;
--text-primary: #2c3e50;
--text-secondary: #7f8c8d;
--shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
--border-radius: 12px;
--btn-padding-y: 14px;
--btn-padding-x: 28px;
--btn-font-size: 16px;
--btn-line-height: 1.5;
--btn-border-width: 2px;
--btn-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
* { box-sizing: border-box; }
body {
font-family: 'Tajawal', 'Segoe UI', sans-serif;
background-color: var(--light-bg);
margin: 0;
padding: 0;
color: var(--text-primary);
line-height: 1.6;
}
.hidden { display: none !important; }
.message {
padding: 15px;
margin: 20px 0;
border-radius: 8px;
font-weight: 500;
text-align: center;
}
.message.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.message.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.text-center { text-align: center; }
.mt-20 { margin-top: 20px; }

/* --- Location & Map Styles --- */
.location-section {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
padding: 20px;
border-radius: var(--border-radius);
margin-bottom: 20px;
text-align: center;
}

.location-header {
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
margin-bottom: 15px;
}

.location-header h3 {
margin: 0;
font-size: 1.3em;
}

#mapContainer {
height: 400px;
border-radius: var(--border-radius);
overflow: hidden;
margin: 20px 0;
box-shadow: var(--shadow);
position: relative;
}

.map-controls {
position: absolute;
top: 10px;
left: 10px;
z-index: 1000;
display: flex;
flex-direction: column;
gap: 10px;
}

.map-control-btn {
background: white;
border: none;
border-radius: 8px;
padding: 10px;
cursor: pointer;
box-shadow: 0 2px 5px rgba(0,0,0,0.2);
transition: var(--btn-transition);
width: 40px;
height: 40px;
display: flex;
align-items: center;
justify-content: center;
}

.map-control-btn:hover {
background: var(--primary-color);
color: white;
transform: scale(1.1);
}

.location-filters {
background: var(--card-bg);
padding: 20px;
border-radius: var(--border-radius);
margin-bottom: 20px;
box-shadow: var(--shadow);
}

.distance-filter {
display: flex;
align-items: center;
gap: 15px;
margin-bottom: 15px;
}

.distance-slider {
flex: 1;
-webkit-appearance: none;
height: 6px;
border-radius: 3px;
background: #ddd;
outline: none;
}

.distance-slider::-webkit-slider-thumb {
-webkit-appearance: none;
appearance: none;
width: 20px;
height: 20px;
border-radius: 50%;
background: var(--primary-color);
cursor: pointer;
}

.distance-value {
min-width: 80px;
text-align: center;
font-weight: bold;
color: var(--primary-color);
}

.location-badge {
display: inline-flex;
align-items: center;
gap: 5px;
background: rgba(52, 152, 219, 0.1);
color: var(--primary-color);
padding: 5px 10px;
border-radius: 20px;
font-size: 0.9em;
margin: 5px;
}

.venue-location-info {
display: flex;
align-items: center;
gap: 10px;
margin: 10px 0;
}

.distance-info {
display: flex;
align-items: center;
gap: 5px;
color: var(--secondary-color);
font-weight: 500;
}

.directions-btn {
background: var(--secondary-color);
color: white;
border: none;
padding: 8px 15px;
border-radius: 20px;
cursor: pointer;
transition: var(--btn-transition);
display: inline-flex;
align-items: center;
gap: 5px;
}

.directions-btn:hover {
background: #27ae60;
transform: translateY(-2px);
}

.nearby-venues {
margin-top: 20px;
}

.nearby-title {
display: flex;
align-items: center;
gap: 10px;
margin-bottom: 15px;
color: var(--primary-color);
}

.nearby-list {
display: grid;
gap: 10px;
}

.nearby-item {
background: var(--card-bg);
padding: 15px;
border-radius: var(--border-radius);
display: flex;
justify-content: space-between;
align-items: center;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
transition: var(--btn-transition);
cursor: pointer;
}

.nearby-item:hover {
transform: translateX(-5px);
box-shadow: var(--shadow);
}

.nearby-venue-info {
flex: 1;
}

.nearby-venue-name {
font-weight: bold;
color: var(--text-primary);
}

.nearby-venue-distance {
color: var(--secondary-color);
font-size: 0.9em;
}

.nearby-venue-rating {
color: #ffc107;
}

/* --- Enhanced Button Styles --- */
.btn {
display: inline-flex;
align-items: center;
justify-content: center;
gap: 8px;
padding: var(--btn-padding-y) var(--btn-padding-x);
font-size: var(--btn-font-size);
font-weight: 600;
line-height: var(--btn-line-height);
border: var(--btn-border-width) solid transparent;
border-radius: var(--border-radius);
cursor: pointer;
text-decoration: none;
transition: var(--btn-transition);
user-select: none;
white-space: nowrap;
position: relative;
overflow: hidden;
min-height: 48px;
min-width: 120px;
}

.btn:focus {
outline: none;
box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
}

.btn:active {
transform: translateY(1px);
}

.btn:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none !important;
}

.btn-primary {
background-color: var(--primary-color);
color: white;
border-color: var(--primary-color);
box-shadow: 0 2px 4px rgba(52, 152, 219, 0.2);
}

.btn-primary:hover:not(:disabled) {
background-color: #2980b9;
border-color: #2980b9;
box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
transform: translateY(-2px);
}

.btn-secondary {
background-color: transparent;
color: var(--primary-color);
border-color: var(--primary-color);
}

.btn-secondary:hover:not(:disabled) {
background-color: var(--primary-color);
color: white;
box-shadow: 0 2px 4px rgba(52, 152, 219, 0.2);
transform: translateY(-2px);
}

.btn-success {
background-color: var(--secondary-color);
color: white;
border-color: var(--secondary-color);
box-shadow: 0 2px 4px rgba(46, 204, 113, 0.2);
}

.btn-success:hover:not(:disabled) {
background-color: #27ae60;
border-color: #27ae60;
box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
transform: translateY(-2px);
}

.btn-danger {
background-color: var(--accent-color);
color: white;
border-color: var(--accent-color);
box-shadow: 0 2px 4px rgba(231, 76, 60, 0.2);
}

.btn-danger:hover:not(:disabled) {
background-color: #c0392b;
border-color: #c0392b;
box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
transform: translateY(-2px);
}

.btn-sm {
--btn-padding-y: 8px;
--btn-padding-x: 16px;
--btn-font-size: 14px;
min-height: 36px;
min-width: 100px;
}

.btn-lg {
--btn-padding-y: 18px;
--btn-padding-x: 36px;
--btn-font-size: 18px;
min-height: 56px;
min-width: 160px;
}

.btn-group {
display: flex;
gap: 10px;
flex-wrap: wrap;
justify-content: center;
margin: 20px 0;
}

.btn-group .btn {
flex: 1;
min-width: auto;
}

/* --- Enhanced List Styles --- */
ul, ol {
padding-right: 20px;
margin: 15px 0;
}

ul li, ol li {
margin-bottom: 10px;
position: relative;
padding-right: 10px;
line-height: 1.5;
}

.sidebar ul li::before {
content: "•";
color: var(--primary-color);
font-weight: bold;
display: inline-block;
width: 1em;
margin-left: 0.5em;
position: absolute;
right: -5px;
}

.nav-links {
display: flex;
list-style: none;
padding: 0;
margin: 0;
}

.nav-links li {
margin: 0 10px;
}

.sports-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
gap: 25px;
margin-top: 30px;
list-style: none;
padding: 0;
}

.sports-grid li {
background: var(--card-bg);
border-radius: var(--border-radius);
overflow: hidden;
box-shadow: var(--shadow);
text-align: center;
padding: 30px 20px;
transition: transform 0.3s ease, box-shadow 0.3s ease;
cursor: pointer;
}

.sports-grid li:hover {
transform: translateY(-10px);
box-shadow: 0 12px 25px rgba(0,0,0,0.15);
}

.venues-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
gap: 25px;
margin-top: 30px;
list-style: none;
padding: 0;
}

.venues-grid li {
background: var(--card-bg);
border-radius: var(--border-radius);
overflow: hidden;
box-shadow: var(--shadow);
text-align: right;
transition: transform 0.3s ease, box-shadow 0.3s ease;
cursor: pointer;
}

.venues-grid li:hover {
transform: translateY(-10px);
box-shadow: 0 12px 25px rgba(0,0,0,0.15);
}

/* --- Header & Navigation --- */
.main-header {
background-color: var(--card-bg);
box-shadow: var(--shadow);
padding: 10px 20px;
display: flex;
justify-content: space-between;
align-items: center;
position: sticky;
top: 0;
z-index: 1000;
}
.logo { font-size: 1.5em; font-weight: 700; color: var(--primary-color); }
.nav-links a { 
display: inline-flex;
align-items: center;
gap: 6px;
margin: 0 10px; 
text-decoration: none; 
color: var(--text-primary); 
font-weight: 500; 
transition: var(--btn-transition);
padding: 8px 12px;
border-radius: 8px;
}
.nav-links a:hover { 
color: var(--primary-color);
background-color: rgba(52, 152, 219, 0.1);
}
.user-menu { display: flex; align-items: center; gap: 15px; }
.notification-bell { 
position: relative; 
cursor: pointer; 
font-size: 1.2em; 
color: var(--text-secondary);
padding: 8px;
border-radius: 50%;
transition: var(--btn-transition);
}
.notification-bell:hover {
background-color: rgba(52, 152, 219, 0.1);
color: var(--primary-color);
}
.notification-badge { position: absolute; top: -5px; left: -8px; background-color: var(--accent-color); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold; }
.notification-dropdown { position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: var(--shadow); width: 300px; max-height: 400px; overflow-y: auto; display: none; z-index: 1001; }
.notification-dropdown.show { display: block; }
.notification-item { 
padding: 12px; 
border-bottom: 1px solid #eee; 
text-align: right; 
font-size: 0.9em; 
cursor: pointer;
transition: var(--btn-transition);
}
.notification-item:hover {
background-color: var(--light-bg);
}

/* --- Main Menu Page --- */
#mainMenuPage { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: calc(100vh - 60px); text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; }
#mainMenuPage h1 { font-size: 3.5em; margin-bottom: 10px; }
#mainMenuPage p { font-size: 1.2em; margin-bottom: 40px; }
.menu-buttons { 
display: flex; 
gap: 20px; 
flex-wrap: wrap; 
justify-content: center; 
list-style: none; 
padding: 0;
width: 100%;
max-width: 600px;
}
.menu-button { 
background: rgba(255, 255, 255, 0.15); 
backdrop-filter: blur(10px); 
border: 2px solid rgba(255, 255, 255, 0.3); 
color: white; 
padding: 20px 40px; 
border-radius: var(--border-radius); 
font-size: 1.2em; 
cursor: pointer; 
transition: var(--btn-transition);
display: flex;
align-items: center;
justify-content: center;
gap: 12px;
min-height: 60px;
flex: 1;
min-width: 200px;
}
.menu-button:hover { 
background: rgba(255, 255, 255, 0.3); 
transform: translateY(-5px);
box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}
.menu-button:active {
transform: translateY(-2px);
}

/* --- Sports Selection Page --- */
#sportsSelectionPage .container { padding: 20px; }
#sportsSelectionPage h2 { margin-bottom: 30px; color: var(--primary-color); }
.sport-card { 
background: var(--card-bg); 
border-radius: var(--border-radius); 
overflow: hidden; 
box-shadow: var(--shadow); 
text-align: center; 
padding: 30px 20px; 
transition: var(--btn-transition); 
cursor: pointer;
display: flex;
flex-direction: column;
align-items: center;
gap: 15px;
}
.sport-card:hover { 
transform: translateY(-10px); 
box-shadow: 0 12px 25px rgba(0,0,0,0.15);
}
.sport-icon { font-size: 4em; color: var(--primary-color); }
.sport-card h3 { margin: 0; color: var(--primary-color); }
.sport-card p { margin: 0; color: var(--text-secondary); }

/* --- Container & Forms --- */
.container { max-width: 900px; margin: 30px auto; padding: 40px; background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center; }
.container h2 { margin-bottom: 30px; color: var(--primary-color); }
.form-group { margin-bottom: 20px; text-align: right; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
.form-group input, .form-group select, .form-group textarea { 
width: 100%; 
padding: 12px; 
border: 1px solid #ddd; 
border-radius: 8px; 
font-size: 16px;
transition: var(--btn-transition);
}
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
border-color: var(--primary-color); 
outline: none;
box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

/* --- Cards & Grids --- */
.venue-card { 
background: var(--card-bg); 
border-radius: var(--border-radius); 
overflow: hidden; 
box-shadow: var(--shadow); 
text-align: right; 
transition: var(--btn-transition); 
cursor: pointer;
display: flex;
flex-direction: column;
}
.venue-card:hover { 
transform: translateY(-10px); 
box-shadow: 0 12px 25px rgba(0,0,0,0.15);
}
.venue-image-placeholder { 
height: 180px; 
background-color: #e9ecef; 
display: flex; 
align-items: center; 
justify-content: center; 
color: #6c757d; 
font-size: 3em;
flex-shrink: 0;
}
.venue-card-body { 
padding: 20px; 
flex-grow: 1;
display: flex;
flex-direction: column;
gap: 8px;
}
.venue-card-body h3 { margin: 0; color: var(--primary-color); }
.venue-card-body p { margin: 0; color: var(--text-secondary); display: flex; align-items: center; }
.venue-card-body i { margin-left: 10px; width: 20px; text-align: center; color: var(--primary-color); }

/* --- Booking & Details --- */
.booking-info { background-color: #eef7ff; border: 1px solid #bde0ff; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: right; }
.time-slots-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 20px; }
.time-slot { 
padding: 15px; 
border: 2px solid var(--primary-color); 
border-radius: 8px; 
text-align: center; 
cursor: pointer; 
transition: var(--btn-transition);
min-height: 80px;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
gap: 5px;
}
.time-slot.available { 
background-color: var(--card-bg); 
color: var(--primary-color);
}
.time-slot.available:hover { 
background-color: var(--primary-color); 
color: white;
transform: translateY(-2px);
box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
}
.time-slot.booked { 
background-color: #f8d7da; 
color: #721c24; 
border-color: #f5c6cb; 
cursor: not-allowed;
opacity: 0.7;
}
.booking-list-item { background-color: var(--light-bg); padding: 15px; border-radius: 8px; margin-bottom: 10px; text-align: right; border-right: 4px solid var(--secondary-color); }
.price-tag { font-weight: bold; color: var(--secondary-color); font-size: 1.2em; }

/* --- Dashboard Stats --- */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; list-style: none; padding: 0; }
.stat-card { 
background: linear-gradient(135deg, var(--primary-color), #5dade2); 
color: white; 
padding: 20px; 
border-radius: var(--border-radius); 
text-align: center;
transition: var(--btn-transition);
}
.stat-card:hover {
transform: translateY(-5px);
box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
}
.stat-card h3 { font-size: 2em; margin: 0; }
.stat-card p { margin: 5px 0 0 0; }

/* --- Tournaments --- */
.tournament-card { 
border: 1px solid #ddd; 
padding: 20px; 
border-radius: var(--border-radius); 
margin-bottom: 15px; 
text-align: right;
transition: var(--btn-transition);
}
.tournament-card:hover {
box-shadow: var(--shadow);
transform: translateY(-2px);
}
.tournament-card h4 { color: var(--primary-color); margin-top: 0; }

/* --- Ratings --- */
.rating { direction: ltr; display: inline-block; font-size: 1.5em; }
.rating .star { 
color: #ddd; 
cursor: pointer;
transition: var(--btn-transition);
}
.rating .star:hover {
color: #ffc107;
transform: scale(1.1);
}
.rating .star.filled { color: #ffc107; }
.review-item { text-align: right; border-bottom: 1px solid #eee; padding: 15px 0; }
.review-item:last-child { border-bottom: none; }
.review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }

/* --- Filters --- */
.filters-container { 
background-color: #f8f9fa; 
padding: 20px; 
border-radius: var(--border-radius); 
margin-bottom: 30px; 
text-align: right; 
display: flex; 
gap: 15px; 
flex-wrap: wrap; 
align-items: end;
}
.filters-container .form-group { margin-bottom: 0; flex-grow: 1; }

/* --- Admin & Owner Dashboard Styles --- */
.dashboard-container { display: flex; max-width: 1400px; margin: 20px auto; gap: 20px; padding: 0 20px; }
.sidebar { 
flex: 0 0 250px; 
background: var(--card-bg); 
padding: 20px; 
border-radius: var(--border-radius); 
box-shadow: var(--shadow); 
height: fit-content;
}
.sidebar h3 { margin-top: 0; color: var(--primary-color); }
.sidebar ul { list-style: none; padding: 0; }
.sidebar li { margin-bottom: 10px; }
.sidebar a { 
display: flex; 
align-items: center; 
gap: 10px;
padding: 12px 15px; 
text-decoration: none; 
color: var(--text-primary); 
border-radius: 8px; 
transition: var(--btn-transition);
}
.sidebar a:hover, .sidebar a.active { 
background-color: var(--primary-color); 
color: white;
transform: translateX(-5px);
}
.content { 
flex-grow: 1; 
background: var(--card-bg); 
padding: 30px; 
border-radius: var(--border-radius); 
box-shadow: var(--shadow); 
text-align: right; 
}
.admin-table { 
width: 100%; 
border-collapse: collapse; 
margin-top: 20px; 
}
.admin-table th, .admin-table td { 
padding: 12px; 
text-align: right; 
border-bottom: 1px solid #ddd; 
}
.admin-table th { 
background-color: var(--light-bg); 
font-weight: 700; 
}
.admin-table .actions { 
display: flex; 
gap: 8px; 
justify-content: center; 
flex-wrap: wrap; 
}
.admin-table .actions button { 
padding: 6px 12px; 
font-size: 14px;
min-width: auto;
}

/* --- Payment Methods --- */
.payment-methods { 
display: flex; 
justify-content: center; 
margin-bottom: 30px; 
list-style: none; 
padding: 0;
gap: 15px;
}
.payment-method { 
flex: 1; 
max-width: 200px; 
padding: 20px; 
border: 2px solid #ddd; 
border-radius: var(--border-radius); 
cursor: pointer; 
text-align: center; 
transition: var(--btn-transition);
}
.payment-method:hover {
border-color: var(--primary-color);
transform: translateY(-5px);
box-shadow: var(--shadow);
}
.payment-method.active { 
border-color: var(--primary-color); 
background-color: #f0f8ff;
}
.payment-method i { 
font-size: 2em; 
margin-bottom: 10px; 
display: block; 
color: var(--primary-color); 
}
.payment-form-container { margin-top: 20px; }

/* --- Chat Page Styles --- */
#chatPage, #adminChatPage { padding: 20px; }
.chat-container { 
max-width: 700px; 
margin: 0 auto; 
background: var(--card-bg); 
border-radius: var(--border-radius); 
box-shadow: var(--shadow); 
display: flex; 
flex-direction: column; 
height: 70vh; 
}
.chat-header { 
background-color: var(--primary-color); 
color: white; 
padding: 15px 20px; 
border-top-left-radius: var(--border-radius); 
border-top-right-radius: var(--border-radius); 
font-size: 1.2em; 
font-weight: bold; 
display: flex; 
justify-content: space-between; 
align-items: center; 
}
.chat-messages { 
flex-grow: 1; 
padding: 20px; 
overflow-y: auto; 
display: flex; 
flex-direction: column; 
gap: 15px; 
}
.message-bubble { 
max-width: 75%; 
padding: 12px 16px; 
border-radius: 18px; 
line-height: 1.4; 
position: relative;
transition: var(--btn-transition);
}
.message-bubble:hover {
transform: scale(1.02);
}
.message-bubble.user { 
background-color: var(--primary-color); 
color: white; 
align-self: flex-end; 
border-bottom-right-radius: 5px; 
}
.message-bubble.admin { 
background-color: #e9ecef; 
color: var(--text-primary); 
align-self: flex-start; 
border-bottom-left-radius: 5px; 
}
.message-bubble img { 
max-width: 100%; 
border-radius: var(--border-radius); 
margin-top: 5px; 
}
.chat-input-container { 
display: flex; 
padding: 15px; 
border-top: 1px solid #ddd; 
align-items: center; 
gap: 10px; 
}
.chat-input-container input[type="text"] { 
flex-grow: 1; 
border: 1px solid #ccc; 
border-radius: 20px; 
padding: 10px 15px;
transition: var(--btn-transition);
}
.chat-input-container input[type="text"]:focus {
border-color: var(--primary-color);
box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}
.chat-input-container input[type="file"] { display: none; }
.chat-input-container .btn { 
border-radius: 50%; 
width: 45px; 
height: 45px; 
padding: 0; 
display: flex; 
align-items: center; 
justify-content: center; 
font-size: 1.2em;
min-width: auto;
}

/* --- Dynamic Form Fields --- */
#venueSpecificFields { margin-top: 20px; }
.checkbox-group { 
display: flex; 
flex-wrap: wrap; 
gap: 15px; 
text-align: right; 
list-style: none; 
padding: 0;
}
.checkbox-group label { 
display: flex; 
align-items: center; 
gap: 8px; 
font-weight: normal;
padding: 8px 12px;
border-radius: 8px;
transition: var(--btn-transition);
cursor: pointer;
}
.checkbox-group label:hover {
background-color: rgba(52, 152, 219, 0.1);
}
.checkbox-group input[type="checkbox"] {
width: 18px;
height: 18px;
cursor: pointer;
}

/* --- PayPal Styles --- */
#paypal-button-container {
margin: 20px 0;
}

.discount-code-section {
background-color: #f8f9fa;
padding: 15px;
border-radius: 8px;
margin-bottom: 20px;
text-align: right;
}

.discount-code-form {
display: flex;
gap: 10px;
align-items: center;
}

.discount-code-input {
flex: 1;
}

.discount-applied {
color: var(--secondary-color);
font-weight: bold;
margin-top: 10px;
}

.payment-summary {
background-color: #eef7ff;
border: 1px solid #bde0ff;
padding: 15px;
border-radius: 8px;
margin-bottom: 20px;
text-align: right;
}

.price-breakdown {
display: flex;
justify-content: space-between;
margin-bottom: 10px;
}

.price-breakdown.total {
font-weight: bold;
font-size: 1.2em;
border-top: 1px solid #ddd;
padding-top: 10px;
}

/* --- Responsive Design --- */
@media (max-width: 768px) {
.container { padding: 20px; margin: 20px auto; }
.main-header { flex-direction: column; gap: 10px; }
.nav-links { display: none; }
.filters-container { flex-direction: column; align-items: stretch; }
.filters-container .form-group { width: 100%; }
.stats-grid { grid-template-columns: 1fr; }
.dashboard-container { flex-direction: column; }
.sidebar { flex: none; width: 100%; }
.payment-methods { flex-direction: column; }
.payment-method { margin: 10px 0; }
.admin-table .actions { flex-direction: column; }
.menu-buttons {
flex-direction: column;
max-width: 300px;
}
.menu-button {
min-width: auto;
}
.btn {
--btn-padding-x: 20px;
--btn-padding-y: 12px;
}
#mapContainer {
height: 300px;
}
.map-controls {
top: 5px;
left: 5px;
}
.map-control-btn {
width: 35px;
height: 35px;
}
}
</style>
</head>
<body>

<!-- ================ Header ================ -->
<header class="main-header hidden" id="appHeader">
<div class="logo">ملعبي</div>
<nav class="nav-links">
<a href="#" onclick="showPage('sportsSelectionPage')"><i class="fas fa-running"></i> الرياضات</a>
<a href="#" onclick="showPage('tournamentsPage')"><i class="fas fa-trophy"></i> البطولات</a>
</nav>
<div class="user-menu">
<div class="notification-bell" onclick="toggleNotifications()">
<i class="fas fa-bell"></i>
<span class="notification-badge" id="notificationBadge">3</span>
<div class="notification-dropdown" id="notificationDropdown"></div>
</div>
<span id="headerUserName">ضيف</span>
<button class="btn btn-secondary btn-sm" onclick="showPage('mainMenuPage')">
<i class="fas fa-home"></i> القائمة الرئيسية
</button>
</div>
</header>

<!-- ================ 1. Main Menu ================ -->
<div id="mainMenuPage">
<h1>مرحباً بك في منصة ملعبي</h1>
<p>منصتك الشاملة لحجز جميع المنشآت الرياضية</p>
<ul class="menu-buttons">
<li class="menu-button" onclick="showPage('sportsSelectionPage')">
<i class="fas fa-running"></i> 
<span>استكشف الرياضات</span>
</li>
<li class="menu-button" onclick="showPage('ownerLoginPage')">
<i class="fas fa-store"></i> 
<span>أنا صاحب منشأة</span>
</li>
<li class="menu-button" onclick="showPage('adminLoginPage')">
<i class="fas fa-cogs"></i> 
<span>صفحة الإدارة</span>
</li>
</ul>
</div>

<!-- ================ 2. Sports Selection Page ================ -->
<div id="sportsSelectionPage" class="container hidden">
<h2><i class="fas fa-running"></i> اختر الرياضة التي تريد ممارستها</h2>
<ul class="sports-grid">
<li class="sport-card" onclick="selectSport('football')">
<div class="sport-icon"><i class="fas fa-futbol"></i></div>
<h3>كرة القدم</h3>
<p>احجز ملاعب كرة القدم</p>
</li>
<li class="sport-card" onclick="selectSport('volleyball')">
<div class="sport-icon"><i class="fas fa-volleyball-ball"></i></div>
<h3>كرة الطائرة</h3>
<p>احزر ملاعب كرة الطائرة</p>
</li>
<li class="sport-card" onclick="selectSport('basketball')">
<div class="sport-icon"><i class="fas fa-basketball-ball"></i></div>
<h3>كرة السلة</h3>
<p>احجز ملاعب كرة السلة</p>
</li>
<li class="sport-card" onclick="selectSport('tennis')">
<div class="sport-icon"><i class="fas fa-table-tennis"></i></div>
<h3>تنس الطاولة</h3>
<p>احزر ملاعب تنس الطاولة</p>
</li>
<li class="sport-card" onclick="selectSport('swimming')">
<div class="sport-icon"><i class="fas fa-swimmer"></i></div>
<h3>السباحة</h3>
<p>احجز مسابح</p>
</li>
<li class="sport-card" onclick="selectSport('esports')">
<div class="sport-icon"><i class="fas fa-gamepad"></i></div>
<h3>الرياضات الإلكترونية</h3>
<p>احزر مقاعد إلكترونية</p>
</li>
</ul>
<div class="btn-group">
<button class="btn btn-secondary btn-lg" onclick="showPage('mainMenuPage')">
<i class="fas fa-arrow-right"></i> العودة للقائمة الرئيسية
</button>
</div>
</div>

<!-- ================ Player Interface (Venues List) ================ -->
<div id="playerInterface" class="container hidden">
<h2 id="playerInterfaceTitle"><i class="fas fa-futbol"></i> اكتشف المنشآت الرياضية</h2>

<!-- Location Section -->
<div class="location-section">
<div class="location-header">
<i class="fas fa-map-marked-alt"></i>
<h3>اكتشف المنشآت القريبة منك</h3>
</div>
<button class="btn btn-primary" onclick="getUserLocation()">
<i class="fas fa-location-arrow"></i> تحديد موقعي الحالي
</button>
</div>

<!-- Map Container -->
<div id="mapContainer">
<div class="map-controls">
<button class="map-control-btn" onclick="centerMapOnUser()" title="موقعي">
<i class="fas fa-crosshairs"></i>
</button>
<button class="map-control-btn" onclick="toggleMapStyle()" title="تغيير الخريطة">
<i class="fas fa-layer-group"></i>
</button>
<button class="map-control-btn" onclick="toggleFullscreen()" title="ملء الشاشة">
<i class="fas fa-expand"></i>
</button>
</div>
</div>

<!-- Location Filters -->
<div class="location-filters">
<div class="distance-filter">
<label>البحث ضمن مسافة:</label>
<input type="range" class="distance-slider" id="distanceSlider" min="1" max="50" value="10" oninput="updateDistanceFilter(this.value)">
<span class="distance-value" id="distanceValue">10 كم</span>
</div>
<div class="btn-group">
<button class="btn btn-primary" onclick="filterByDistance()">
<i class="fas fa-filter"></i> تطبيق المسافة
</button>
<button class="btn btn-secondary" onclick="clearLocationFilter()">
<i class="fas fa-times"></i> مسح التصفية
</button>
</div>
</div>

<div class="filters-container">
<div class="form-group"><label for="citySearchInput">المدينة</label><input type="text" id="citySearchInput" placeholder="مثال: الرياض"></div>
<div class="form-group"><label>نوع السطح</label><select id="filterSurface"><option value="">الكل</option></select></div>
<div class="form-group"><label>حجم المنشأة</label><select id="filterSize"><option value="">الكل</option></select></div>
<div class="form-group"><label>إضاءة ليلية</label><select id="filterLights"><option value="">الكل</option><option value="true">متوفرة</option><option value="false">غير متوفرة</option></select></div>
<div class="btn-group">
<button type="button" class="btn btn-primary" onclick="applyFilters()">
<i class="fas fa-search"></i> بحث
</button>
<button type="button" class="btn btn-secondary" onclick="displayVenuesForPlayer()">
<i class="fas fa-list"></i> عرض الكل
</button>
</div>
</div>

<!-- Nearby Venues Section -->
<div class="nearby-venues" id="nearbyVenues">
<div class="nearby-title">
<i class="fas fa-map-pin"></i>
<h3>المنشآت القريبة</h3>
</div>
<div class="nearby-list" id="nearbyList">
<!-- Nearby venues will be populated here -->
</div>
</div>

<ul id="venuesListForPlayer" class="venues-grid"></ul>
<div class="btn-group">
<button class="btn btn-secondary" onclick="showPage('sportsSelectionPage')">
<i class="fas fa-arrow-right"></i> العودة لاختيار الرياضة
</button>
</div>
</div>

<!-- ================ Venue Detail & Booking ================ -->
<div id="venueDetailPage" class="container hidden">
<button class="btn btn-secondary" onclick="showPage('playerInterface')">
<i class="fas fa-arrow-right"></i> العودة لقائمة المنشآت
</button>
<h2 id="detailVenueName"></h2>

<!-- Enhanced Location Info -->
<div class="venue-location-info">
<div class="location-badge">
<i class="fas fa-map-marker-alt"></i>
<span id="venueLocationText"></span>
</div>
<div class="distance-info" id="venueDistance">
<i class="fas fa-route"></i>
<span>جاري حساب المسافة...</span>
</div>
<button class="directions-btn" onclick="getDirections()">
<i class="fas fa-directions"></i>
الحصول على الاتجاهات
</button>
</div>

<div id="detailVenueInfo" class="booking-info"></div>

<!-- Enhanced Map -->
<div id="venueMap" style="margin: 20px 0; border-radius: 8px; overflow: hidden; height: 300px;"></div>

<h3>احجز وقتك</h3>
<div class="form-group"><label for="bookingDate">اختر يوم الحجز</label><input type="date" id="bookingDate" onchange="generateTimeSlots()"></div>
<div id="timeSlotsContainer" class="time-slots-container"></div>
<div id="bookingMessage" class="message hidden"></div>
<h3>التقييمات والمراجعات</h3>
<div id="reviewsContainer"></div>
</div>

<!-- ================ Payment Page ================ -->
<div id="paymentPage" class="container hidden">
<h2><i class="fas fa-credit-card"></i> إتمام الدفع</h2>
<div class="payment-summary">
<h3>ملخص الطلب</h3>
<div class="price-breakdown">
<span>المنشأة:</span>
<span id="summaryVenueName"></span>
</div>
<div class="price-breakdown">
<span>التاريخ:</span>
<span id="summaryDate"></span>
</div>
<div class="price-breakdown">
<span>الوقت:</span>
<span id="summaryTime"></span>
</div>
<div class="price-breakdown">
<span>السعر الأساسي:</span>
<span id="summaryBasePrice"></span>
</div>
<div class="price-breakdown discount" id="summaryDiscountRow" style="display: none;">
<span>الخصم:</span>
<span id="summaryDiscount"></span>
</div>
<div class="price-breakdown total">
<span>المبلغ الإجمالي:</span>
<span id="summaryTotalPrice"></span>
</div>
</div>

<div class="discount-code-section">
<h3>كود الخصم</h3>
<div class="discount-code-form">
<input type="text" id="discountCodeInput" class="form-control discount-code-input" placeholder="أدخل كود الخصم">
<button class="btn btn-primary" onclick="applyDiscountCode()">
<i class="fas fa-tag"></i> تطبيق
</button>
</div>
<div id="discountMessage" class="discount-applied" style="display: none;"></div>
</div>

<div class="payment-methods">
<div class="payment-method active" onclick="selectPaymentMethod('paypal')">
<i class="fab fa-paypal"></i>
<span>PayPal</span>
</div>
<div class="payment-method" onclick="selectPaymentMethod('card')">
<i class="fas fa-credit-card"></i>
<span>بطاقة ائتمانية</span>
</div>
</div>

<div class="payment-form-container">
<div id="paypalForm">
<div id="paypal-button-container"></div>
<p style="text-align: center; margin-top: 10px;">
<i class="fas fa-lock"></i> عملية الدفع آمنة ومشفرة
</p>
</div>
<div id="cardForm" class="hidden">
<form id="creditCardForm">
<div class="form-group">
<label>اسم حامل البطاقة</label>
<input type="text" id="cardName" required>
</div>
<div class="form-group">
<label>رقم البطاقة</label>
<input type="text" id="cardNumber" required>
</div>
<div style="display: flex; gap: 15px;">
<div class="form-group" style="flex: 1;">
<label>تاريخ الانتهاء</label>
<input type="text" id="cardExpiry" placeholder="MM/YY" required>
</div>
<div class="form-group" style="flex: 1;">
<label>CVV</label>
<input type="text" id="cardCvv" required>
</div>
</div>
<button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
<i class="fas fa-lock"></i> إتمام الدفع الآمن
</button>
</form>
</div>
</div>
<div id="paymentMessage" class="message hidden"></div>
</div>

<!-- ================ Owner Login ================ -->
<div id="ownerLoginPage" class="container hidden">
<h2><i class="fas fa-store"></i> تسجيل دخول صاحب المنشأة</h2>
<form id="ownerLoginForm">
<div class="form-group"><label for="ownerLoginEmail">البريد الإلكتروني</label><input type="email" id="ownerLoginEmail" required></div>
<div class="form-group"><label for="ownerLoginPassword">الرمز السري</label><input type="password" id="ownerLoginPassword" required></div>
<div class="btn-group">
<button type="submit" class="btn btn-primary">
<i class="fas fa-sign-in-alt"></i> دخول
</button>
</div>
</form>
<div id="ownerLoginMessage" class="message hidden"></div>
<p>ليس لديك حساب؟ <a href="#" onclick="showPage('ownerRegistrationPage')">إنشاء حساب جديد</a></p>
<div class="btn-group">
<button class="btn btn-secondary" onclick="showPage('mainMenuPage')">
<i class="fas fa-home"></i> العودة للقائمة الرئيسية
</button>
</div>
</div>

<!-- ================ Owner Registration ================ -->
<div id="ownerRegistrationPage" class="container hidden">
<h2><i class="fas fa-user-plus"></i> إنشاء حساب جديد</h2>
<form id="ownerRegistrationForm">
<div class="form-group"><label for="ownerName">الاسم الكامل</label><input type="text" id="ownerName" required></div>
<div class="form-group"><label for="ownerEmail">البريد الإلكتروني</label><input type="email" id="ownerEmail" required></div>
<div class="form-group"><label for="ownerPassword">الرمز السري</label><input type="password" id="ownerPassword" required></div>
<div class="form-group"><label for="ownerPhone">رقم الهاتف</label><input type="tel" id="ownerPhone" required></div>
<div class="btn-group">
<button type="submit" class="btn btn-primary">
<i class="fas fa-user-plus"></i> إنشاء حساب
</button>
</div>
</form>
<div id="registrationMessage" class="message hidden"></div>
<div class="btn-group">
<button class="btn btn-secondary" onclick="showPage('ownerLoginPage')">
<i class="fas fa-arrow-left"></i> العودة لتسجيل الدخول
</button>
</div>
</div>

<!-- ================ Owner Dashboard ================ -->
<div id="ownerDashboard" class="hidden">
<div class="dashboard-container">
<aside class="owner-sidebar">
<h3>لوحة تحكم صاحب المنشأة</h3>
<ul>
<li><a href="#" class="active" onclick="showOwnerSection('overview')"><i class="fas fa-chart-line"></i> الإحصائيات</a></li>
<li><a href="#" onclick="showOwnerSection('venues')"><i class="fas fa-building"></i> المنشآت الخاصة بي</a></li>
<li><a href="#" onclick="showOwnerSection('add-venue')"><i class="fas fa-plus-circle"></i> إضافة منشأة جديدة</a></li>
<li><a href="#" onclick="showOwnerSection('bookings')"><i class="fas fa-calendar-check"></i> إدارة الحجوزات</a></li>
<li><a href="#" onclick="showOwnerSection('tournaments')"><i class="fas fa-trophy"></i> إدارة البطولات</a></li>
</ul>
<button class="btn btn-danger" style="width: 100%; margin-top: 20px;" onclick="logout()">
<i class="fas fa-sign-out-alt"></i> تسجيل الخروج
</button>
</aside>
<main class="owner-content" id="ownerContent">
<!-- Content will be loaded here dynamically -->
</main>
</div>
</div>

<!-- ================ Admin Login ================ -->
<div id="adminLoginPage" class="container hidden">
<h2><i class="fas fa-cogs"></i> لوحة تحكم الإدارة</h2>
<form id="adminLoginForm">
<div class="form-group"><label for="adminEmail">البريد الإلكتروني</label><input type="email" id="adminEmail" required></div>
<div class="form-group"><label for="adminPassword">الرمز السري</label><input type="password" id="adminPassword" required></div>
<div class="btn-group">
<button type="submit" class="btn btn-primary">
<i class="fas fa-sign-in-alt"></i> دخول
</button>
</div>
</form>
<div id="loginMessage" class="message hidden"></div>
<div class="btn-group">
<button class="btn btn-secondary" onclick="showPage('mainMenuPage')">
<i class="fas fa-home"></i> العودة للقائمة الرئيسية
</button>
</div>
</div>

<!-- ================ Admin Dashboard ================ -->
<div id="adminDashboard" class="hidden">
<div class="dashboard-container">
<aside class="admin-sidebar">
<h3>لوحة التحكم</h3>
<ul>
<li><a href="#" class="active" onclick="showAdminSection('overview')"><i class="fas fa-chart-line"></i> الإحصائيات</a></li>
<li><a href="#" onclick="showAdminSection('approvals')"><i class="fas fa-user-check"></i> الموافقة على الحسابات</a></li>
<li><a href="#" onclick="showAdminSection('users')"><i class="fas fa-users"></i> إدارة الحسابات</a></li>
<li><a href="#" onclick="showAdminSection('venues')"><i class="fas fa-building"></i> إدارة المنشآت</a></li>
<li><a href="#" onclick="showAdminSection('add-venue')"><i class="fas fa-plus-circle"></i> إضافة منشأة جديدة</a></li>
<li><a href="#" onclick="showAdminSection('bookings')"><i class="fas fa-calendar-check"></i> إدارة الحجوزات</a></li>
<li><a href="#" onclick="showAdminSection('tournaments')"><i class="fas fa-trophy"></i> إدارة البطولات</a></li>
<li><a href="#" onclick="showAdminSection('discounts')"><i class="fas fa-tags"></i> إدارة الخصومات</a></li>
</ul>
<button class="btn btn-danger" style="width: 100%; margin-top: 20px;" onclick="logout()">
<i class="fas fa-sign-out-alt"></i> تسجيل الخروج
</button>
</aside>
<main class="admin-content" id="adminContent">
<!-- Content will be loaded here dynamically -->
</main>
</div>
</div>

<!-- ================ Chat Page (for Player) ================ -->
<div id="chatPage" class="container hidden">
<button class="btn btn-secondary" onclick="showPage('playerInterface')">
<i class="fas fa-arrow-right"></i> العودة
</button>
<div class="chat-container">
<div class="chat-header"><span>دردشة تأكيد الحجز</span><span id="chatStatus">في انتظار تأكيد الدفع</span></div>
<div id="chatMessages" class="chat-messages"></div>
<div class="chat-input-container">
<input type="text" id="chatInput" placeholder="اكتب رسالتك...">
<label for="imageUpload" class="btn btn-secondary btn-icon">
<i class="fas fa-image"></i>
</label>
<input type="file" id="imageUpload" accept="image/*" onchange="sendImage(event)">
<button class="btn btn-primary btn-icon" onclick="sendMessage()">
<i class="fas fa-paper-plane"></i>
</button>
</div>
</div>
</div>

<!-- ================ Admin Chat Page ================ -->
<div id="adminChatPage" class="container hidden">
<button class="btn btn-secondary" onclick="showAdminSection('bookings')">
<i class="fas fa-arrow-right"></i> العودة للحجوزات
</button>
<div class="chat-container">
<div class="chat-header"><span>دردشة تأكيد الحجز</span><span id="adminChatStatus">مراجعة الحجز</span></div>
<div id="adminChatMessages" class="chat-messages"></div>
<div class="chat-input-container">
<input type="text" id="adminChatInput" placeholder="اكتب رسالتك...">
<button class="btn btn-success" onclick="confirmBookingFromChat()">
<i class="fas fa-check"></i> تأكيد الحجز
</button>
</div>
</div>
</div>

<!-- ================ Tournaments Page ================ -->
<div id="tournamentsPage" class="container hidden">
<h2><i class="fas fa-trophy"></i> البطولات المتاحة</h2>
<p class="text-center">لتسجيل البطولات، يجب عليك إنشاء حساب كصاحب منشأة.</p>
<div id="tournamentsListContainer"></div>
<div class="btn-group">
<button class="btn btn-secondary" onclick="showPage('mainMenuPage')">
<i class="fas fa-home"></i> العودة للقائمة الرئيسية
</button>
</div>
</div>

<!-- ================ Create Tournament Page ================ -->
<div id="createTournamentPage" class="container hidden">
<h2><i class="fas fa-plus-circle"></i> إنشاء بطولة جديدة</h2>
<form id="createTournamentForm">
<div class="form-group"><label>نوع الرياضة</label><select id="tournamentSport" onchange="populateVenueSelect()" required><option value="football">كرة القدم</option><option value="volleyball">كرة الطائرة</option><option value="basketball">كرة السلة</option><option value="tennis">تنس الطاولة</option><option value="swimming">السباحة</option><option value="esports">رياضات إلكترونية</option></select></div>
<div class="form-group"><label for="tournamentName">اسم البطولة</label><input type="text" id="tournamentName" required></div>
<div class="form-group"><label for="tournamentVenue">المنشأة</label><select id="tournamentVenue" required></select></div>
<div class="form-group"><label for="tournamentDate">تاريخ البطولة</label><input type="date" id="tournamentDate" required></div>
<div class="form-group"><label for="tournamentFee">رسوم التسجيل (ريال)</label><input type="number" id="tournamentFee" required></div>
<div class="form-group"><label for="tournamentDetails">التفاصيل</label><textarea id="tournamentDetails"></textarea></div>
<div class="btn-group">
<button type="submit" class="btn btn-primary">
<i class="fas fa-plus-circle"></i> إنشاء البطولة
</button>
</div>
</form>
<div class="btn-group">
<button class="btn btn-secondary" onclick="showOwnerSection('tournaments')">
<i class="fas fa-arrow-left"></i> العودة للوحة التحكم
</button>
</div>
</div>

<script>
// --- Location & Map Variables ---
let map;
let userMarker;
let venueMarkers = [];
let userLocation = null;
let currentMapStyle = 'street';
let venueMap;

// --- Payment Variables ---
let selectedPaymentMethod = 'paypal';
let appliedDiscount = null;
let paypalButtonRendered = false;

// --- Databases & Data Persistence ---
function loadData() {
    return {
        pendingOwnerAccounts: JSON.parse(localStorage.getItem('pendingOwnerAccounts')) || [],
        approvedOwners: JSON.parse(localStorage.getItem('approvedOwners')) || [],
        publishedVenues: JSON.parse(localStorage.getItem('publishedVenues')) || [],
        allBookings: JSON.parse(localStorage.getItem('allBookings')) || [],
        tournaments: JSON.parse(localStorage.getItem('tournaments')) || [],
        reviews: JSON.parse(localStorage.getItem('reviews')) || [],
        discountCodes: JSON.parse(localStorage.getItem('discountCodes')) || [],
        notifications: JSON.parse(localStorage.getItem('notifications')) || [],
        chatMessages: JSON.parse(localStorage.getItem('chatMessages')) || []
    };
}

function saveData(data) {
    localStorage.setItem('pendingOwnerAccounts', JSON.stringify(data.pendingOwnerAccounts));
    localStorage.setItem('approvedOwners', JSON.stringify(data.approvedOwners));
    localStorage.setItem('publishedVenues', JSON.stringify(data.publishedVenues));
    localStorage.setItem('allBookings', JSON.stringify(data.allBookings));
    localStorage.setItem('tournaments', JSON.stringify(data.tournaments));
    localStorage.setItem('reviews', JSON.stringify(data.reviews));
    localStorage.setItem('discountCodes', JSON.stringify(data.discountCodes));
    localStorage.setItem('notifications', JSON.stringify(data.notifications));
    localStorage.setItem('chatMessages', JSON.stringify(data.chatMessages));
}

let db = loadData();

// --- State Management ---
let currentLoggedInUser = null;
let currentVenueId = null;
let pendingBooking = null;
let currentPendingBookingId = null;
let currentSport = 'football';

// --- Location Functions ---
function initializeMap() {
    if (!map) {
        map = L.map('mapContainer').setView([24.7136, 46.6753], 11); // Default: Riyadh
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Add click event to map
        map.on('click', function(e) {
            console.log('Clicked at: ' + e.latlng);
        });
    }
    
    // Add venue markers
    updateVenueMarkers();
}

function updateVenueMarkers() {
    // Clear existing markers
    venueMarkers.forEach(marker => map.removeLayer(marker));
    venueMarkers = [];

    // Add markers for venues
    db.publishedVenues.forEach(venue => {
        if (venue.sport === currentSport && venue.lat && venue.lng) {
            const marker = L.marker([venue.lat, venue.lng])
                .addTo(map)
                .bindPopup(`
                    <div style="text-align: right; direction: rtl;">
                        <h4>${venue.name}</h4>
                        <p><i class="fas fa-map-marker-alt"></i> ${venue.location}</p>
                        <p><i class="fas fa-phone"></i> ${venue.contact}</p>
                        <button class="btn btn-primary btn-sm" onclick="showVenueDetails(${venue.id})">
                            <i class="fas fa-info-circle"></i> التفاصيل
                        </button>
                    </div>
                `);
            venueMarkers.push(marker);
        }
    });
}

function getUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // Add user marker
                if (userMarker) {
                    map.removeLayer(userMarker);
                }
                
                userMarker = L.marker([userLocation.lat, userLocation.lng], {
                    icon: L.divIcon({
                        html: '<i class="fas fa-user-circle" style="color: #3498db; font-size: 24px;"></i>',
                        iconSize: [24, 24],
                        className: 'user-location-marker'
                    })
                }).addTo(map).bindPopup('موقعك الحالي');
                
                // Center map on user location
                map.setView([userLocation.lat, userLocation.lng], 12);
                
                // Update nearby venues
                updateNearbyVenues();
                calculateDistances();
                
                showNotification('تم تحديد موقعك بنجاح!', 'success');
            },
            error => {
                console.error('Error getting location:', error);
                showNotification('لم نتمكن من تحديد موقعك. يرجى التحقق من إعدادات الموقع.', 'error');
            }
        );
    } else {
        showNotification('المتصفح لا يدعم تحديد الموقع', 'error');
    }
}

function updateNearbyVenues() {
    if (!userLocation) return;
    
    const nearbyList = document.getElementById('nearbyList');
    nearbyList.innerHTML = '';
    
    const maxDistance = parseFloat(document.getElementById('distanceSlider').value);
    const nearbyVenues = db.publishedVenues
        .filter(venue => venue.sport === currentSport)
        .map(venue => {
            const distance = calculateDistance(userLocation, venue);
            return { ...venue, distance };
        })
        .filter(venue => venue.distance <= maxDistance)
        .sort((a, b) => a.distance - b.distance)
        .slice(0, 5); // Show top 5 nearby venues
    
    if (nearbyVenues.length === 0) {
        nearbyList.innerHTML = '<p class="text-center">لا توجد منشآت قريبة ضمن المسافة المحددة</p>';
        return;
    }
    
    nearbyVenues.forEach(venue => {
        const item = document.createElement('div');
        item.className = 'nearby-item';
        item.onclick = () => showVenueDetails(venue.id);
        item.innerHTML = `
            <div class="nearby-venue-info">
                <div class="nearby-venue-name">${venue.name}</div>
                <div class="nearby-venue-distance">
                    <i class="fas fa-route"></i> ${venue.distance.toFixed(1)} كم
                </div>
                <div class="nearby-venue-rating">
                    ${generateStars(getAverageRating(venue.id))}
                </div>
            </div>
            <button class="btn btn-primary btn-sm">
                <i class="fas fa-arrow-left"></i> عرض
            </button>
        `;
        nearbyList.appendChild(item);
    });
}

function calculateDistance(point1, point2) {
    if (!point1.lat || !point1.lng || !point2.lat || !point2.lng) return Infinity;
    
    const R = 6371; // Earth's radius in km
    const dLat = (point2.lat - point1.lat) * Math.PI / 180;
    const dLng = (point2.lng - point1.lng) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function calculateDistances() {
    if (!userLocation) return;
    
    // Update distance display for all venues
    db.publishedVenues.forEach(venue => {
        if (venue.sport === currentSport) {
            venue.distance = calculateDistance(userLocation, venue);
        }
    });
}

function updateDistanceFilter(value) {
    document.getElementById('distanceValue').textContent = value + ' كم';
    if (userLocation) {
        updateNearbyVenues();
    }
}

function filterByDistance() {
    if (!userLocation) {
        showNotification('يرجى تحديد موقعك أولاً', 'error');
        return;
    }
    
    const maxDistance = parseFloat(document.getElementById('distanceSlider').value);
    const filtered = db.publishedVenues.filter(venue => {
        return venue.sport === currentSport && 
               venue.distance && 
               venue.distance <= maxDistance;
    });
    
    renderVenues(filtered);
    showNotification(`تم عرض ${filtered.length} منشأة ضمن مسافة ${maxDistance} كم`, 'success');
}

function clearLocationFilter() {
    document.getElementById('distanceSlider').value = 10;
    document.getElementById('distanceValue').textContent = '10 كم';
    displayVenuesForPlayer();
}

function centerMapOnUser() {
    if (userLocation) {
        map.setView([userLocation.lat, userLocation.lng], 14);
    } else {
        getUserLocation();
    }
}

function toggleMapStyle() {
    // Simple toggle between different tile layers
    const tiles = [
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png'
    ];
    
    currentMapStyle = (currentMapStyle + 1) % tiles.length;
    
    map.eachLayer(layer => {
        if (layer instanceof L.TileLayer) {
            map.removeLayer(layer);
        }
    });
    
    L.tileLayer(tiles[currentMapStyle], {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
}

function toggleFullscreen() {
    const mapContainer = document.getElementById('mapContainer');
    if (!document.fullscreenElement) {
        mapContainer.requestFullscreen().catch(err => {
            console.error('Error attempting to enable fullscreen:', err);
        });
    } else {
        document.exitFullscreen();
    }
}

function getDirections() {
    const venue = db.publishedVenues.find(v => v.id === currentVenueId);
    if (!venue || !userLocation) return;
    
    const url = `https://www.google.com/maps/dir/?api=1&origin=${userLocation.lat},${userLocation.lng}&destination=${venue.lat},${venue.lng}`;
    window.open(url, '_blank');
}

function initializeVenueMap() {
    const venue = db.publishedVenues.find(v => v.id === currentVenueId);
    if (!venue || !venue.lat || !venue.lng) return;
    
    // Initialize venue detail map
    venueMap = L.map('venueMap').setView([venue.lat, venue.lng], 15);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(venueMap);
    
    // Add venue marker
    L.marker([venue.lat, venue.lng])
        .addTo(venueMap)
        .bindPopup(`<b>${venue.name}</b><br>${venue.location}`)
        .openPopup();
    
    // Update distance if user location is available
    if (userLocation) {
        const distance = calculateDistance(userLocation, venue);
        document.getElementById('venueDistance').innerHTML = `
            <i class="fas fa-route"></i>
            <span>${distance.toFixed(1)} كم من موقعك</span>
        `;
    }
    
    document.getElementById('venueLocationText').textContent = venue.location;
}

// --- Page Navigation ---
function showPage(pageId) {
    const pages = document.querySelectorAll('body > div');
    pages.forEach(page => page.classList.add('hidden'));
    document.getElementById(pageId).classList.remove('hidden');

    const header = document.getElementById('appHeader');
    if (['playerInterface', 'venueDetailPage', 'paymentPage', 'tournamentsPage', 'chatPage', 'adminChatPage', 'sportsSelectionPage'].includes(pageId)) {
        header.classList.remove('hidden');
        document.getElementById('headerUserName').textContent = 'ضيف';
    } else {
        header.classList.add('hidden');
    }

    if (pageId === 'playerInterface') {
        displayVenuesForPlayer();
        setTimeout(() => initializeMap(), 100);
    }
    if (pageId === 'venueDetailPage') {
        setTimeout(() => initializeVenueMap(), 100);
    }
    if (pageId === 'ownerDashboard') { showOwnerSection('overview'); }
    if (pageId === 'adminDashboard') { showAdminSection('overview'); }
    if (pageId === 'tournamentsPage') displayAllTournaments();
    if (pageId === 'createTournamentPage') populateVenueSelect();
    if (pageId === 'chatPage') loadChatMessages(currentPendingBookingId, 'user');
    if (pageId === 'adminChatPage') loadChatMessages(currentPendingBookingId, 'admin');
    if (pageId === 'paymentPage') {
        // Reset payment state when showing payment page
        appliedDiscount = null;
        document.getElementById('discountCodeInput').value = '';
        document.getElementById('discountMessage').style.display = 'none';
        updatePaymentSummary();
        renderPayPalButton();
    }
}

// --- Sport Selection ---
function selectSport(sport) {
    currentSport = sport;
    showPage('playerInterface');
    updatePlayerInterfaceHeader();
    updateFiltersForSport();
    displayVenuesForPlayer();
    updateVenueMarkers();
}

function updatePlayerInterfaceHeader() {
    const titles = {
        football: '<i class="fas fa-futbol"></i> اكتشف ملاعب كرة القدم',
        volleyball: '<i class="fas fa-volleyball-ball"></i> اكتشف ملاعب كرة الطائرة',
        basketball: '<i class="fas fa-basketball-ball"></i> اكتشف ملاعب كرة السلة',
        tennis: '<i class="fas fa-table-tennis"></i> اكتشف ملاعب تنس الطاولة',
        swimming: '<i class="fas fa-swimmer"></i> اكتشف المسابح',
        esports: '<i class="fas fa-gamepad"></i> اكتشف مراكز الرياضات الإلكترونية'
    };
    document.getElementById('playerInterfaceTitle').innerHTML = titles[currentSport] || titles['football'];
}

function updateFiltersForSport() {
    const surfaceFilter = document.getElementById('filterSurface');
    const sizeFilter = document.getElementById('filterSize');

    surfaceFilter.innerHTML = '<option value="">الكل</option>';
    sizeFilter.innerHTML = '<option value="">الكل</option>';

    const sportFilters = {
        football: { surface: ['عشبي طبيعي', 'عشبي صناعي'], size: ['5vs5', '7vs7', '11vs11'] },
        volleyball: { surface: ['رمل', 'باركيه'], size: ['مقاس واحد'] },
        basketball: { surface: ['باركيه', 'اسمنتي'], size: ['مقاس واحد'] },
        tennis: { surface: ['أسفلت', 'صلصال', 'عشب'], size: ['مقاس واحد', 'مقاس مزدوج'] },
        swimming: { surface: ['ماء'], size: ['مسبح صغير', 'مسبح كبير', 'مسبح أولمبي'] },
        esports: { surface: ['كمبيوتر', 'PlayStation', 'Xbox'], size: ['غرفة فردية', 'غرفة مزدوجة'] }
    };

    const filters = sportFilters[currentSport] || sportFilters['football'];
    filters.surface.forEach(s => surfaceFilter.innerHTML += `<option value="${s}">${s}</option>`);
    filters.size.forEach(s => sizeFilter.innerHTML += `<option value="${s}">${s}</option>`);
}

// --- Player Interface (Guest) ---
function displayVenuesForPlayer() {
    const venues = db.publishedVenues.filter(v => v.sport === currentSport);
    renderVenues(venues);
}

function applyFilters() {
    const city = document.getElementById('citySearchInput').value.toLowerCase();
    const surface = document.getElementById('filterSurface').value;
    const size = document.getElementById('filterSize').value;
    const lights = document.getElementById('filterLights').value;

    const filtered = db.publishedVenues.filter(v => {
        return v.sport === currentSport &&
            (city ? v.city.toLowerCase().includes(city) : true) &&
            (surface ? v.surface === surface : true) &&
            (size ? v.size === size : true) &&
            (lights ? v.lights.toString() === lights : true);
    });
    renderVenues(filtered);
}

function renderVenues(venuesToRender) {
    const container = document.getElementById('venuesListForPlayer');
    container.innerHTML = '';
    if (venuesToRender.length === 0) { 
        container.innerHTML = '<p class="text-center">لا توجد منشآت مطابقة لبحثك.</p>'; 
        return; 
    }
    
    venuesToRender.forEach(venue => {
        const card = document.createElement('li'); 
        card.className = 'venue-card'; 
        card.onclick = () => showVenueDetails(venue.id);
        
        const avgRating = getAverageRating(venue.id);
        const icon = getSportIcon(venue.sport);
        const distance = venue.distance ? `<div class="distance-info"><i class="fas fa-route"></i> ${venue.distance.toFixed(1)} كم</div>` : '';
        
        card.innerHTML = `
            <div class="venue-image-placeholder"><i class="${icon}"></i></div>
            <div class="venue-card-body">
                <h3>${venue.name}</h3>
                <p><i class="fas fa-map-marker-alt"></i> ${venue.city}</p>
                <p><i class="fas fa-user"></i> ${venue.ownerName}</p>
                <p><i class="fas fa-phone"></i> ${venue.contact}</p>
                ${distance}
                <div class="rating">${generateStars(avgRating)}</div>
            </div>
        `;
        container.appendChild(card);
    });
}

function getSportIcon(sport) {
    const icons = {
        football: 'fas fa-futbol',
        volleyball: 'fas fa-volleyball-ball',
        basketball: 'fas fa-basketball-ball',
        tennis: 'fas fa-table-tennis',
        swimming: 'fas fa-swimmer',
        esports: 'fas fa-gamepad'
    };
    return icons[sport] || 'fas fa-futbol';
}

// --- Venue Detail & Booking (Guest) ---
function showVenueDetails(venueId) {
    currentVenueId = venueId;
    const venue = db.publishedVenues.find(v => v.id === venueId); 
    if (!venue) return;
    
    document.getElementById('detailVenueName').textContent = venue.name;
    
    let infoHtml = `
        <p><strong>المدينة:</strong> ${venue.city}</p>
        <p><strong>الموقع:</strong> ${venue.location}</p>
        <p><strong>التواصل:</strong> ${venue.contact}</p>
        <p><strong>التفاصيل:</strong> ${venue.details || 'لا توجد تفاصيل إضافية'}</p>
        <p><strong>السطح:</strong> ${venue.surface}</p>
        <p><strong>الحجم:</strong> ${venue.size}</p>
        <p><strong>الإضاءة:</strong> ${venue.lights ? 'متوفرة' : 'غير متوفرة'}</p>
    `;
    
    if (venue.sport === 'esports') {
        infoHtml += `
            <p><strong>عدد الأجهزة:</strong> ${venue.equipmentCount || 'N/A'}</p>
            <p><strong>الألعاب المتوفرة:</strong> ${venue.availableGames ? venue.availableGames.join(', ') : 'N/A'}</p>
        `;
    }
    
    document.getElementById('detailVenueInfo').innerHTML = infoHtml;
    document.getElementById('reviewsContainer').innerHTML = renderReviews(venueId);
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('bookingDate').setAttribute('min', today);
    document.getElementById('bookingDate').value = today;
    
    generateTimeSlots();
    showPage('venueDetailPage');
}

function generateTimeSlots() {
    const venue = db.publishedVenues.find(v => v.id === currentVenueId);
    const selectedDate = document.getElementById('bookingDate').value;
    const container = document.getElementById('timeSlotsContainer'); 
    container.innerHTML = '';
    
    for (let hour = venue.openingHour; hour < venue.closingHour; hour++) {
        const timeString = `${hour.toString().padStart(2, '0')}:00`;
        const isBooked = db.allBookings.some(b => 
            b.venueId === currentVenueId && 
            b.date === selectedDate && 
            b.time === timeString && 
            b.paymentStatus === 'confirmed'
        );
        const isPeak = hour >= 18 && hour <= 21;
        const price = isPeak ? venue.pricePeak : venue.priceOffPeak;
        
        const slotDiv = document.createElement('div');
        slotDiv.className = `time-slot ${isBooked ? 'booked' : 'available'}`;
        slotDiv.innerHTML = `
            ${timeString}<br>
            <span class="price-tag">${price} ريال</span>
        `;
        
        if (isBooked) { 
            slotDiv.innerHTML += `<br><small>محجوز</small>`; 
        } else { 
            slotDiv.onclick = () => initiateBooking(selectedDate, timeString, price); 
        }
        
        container.appendChild(slotDiv);
    }
}

function initiateBooking(date, time, price) {
    const playerName = prompt("ادخل رقم الهاتف و أدخل اسمك الكامل لتأكيد الحجز:"); 
    if (!playerName) return;
    
    pendingBooking = { 
        date, 
        time, 
        basePrice: price,
        venueId: currentVenueId,
        venue: db.publishedVenues.find(v => v.id === currentVenueId),
        playerName: playerName
    };
    
    // Update payment summary
    document.getElementById('summaryVenueName').textContent = pendingBooking.venue.name;
    document.getElementById('summaryDate').textContent = pendingBooking.date;
    document.getElementById('summaryTime').textContent = pendingBooking.time;
    document.getElementById('summaryBasePrice').textContent = pendingBooking.basePrice + ' ريال';
    document.getElementById('summaryDiscountRow').style.display = 'none';
    document.getElementById('summaryTotalPrice').textContent = pendingBooking.basePrice + ' ريال';
    
    showPage('paymentPage');
}

// --- Payment Functions ---
function selectPaymentMethod(method) {
    selectedPaymentMethod = method;
    
    // Update UI
    document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('active'));
    document.querySelector(`.payment-method:has(.fa-${method === 'paypal' ? 'paypal' : 'credit-card'})`).classList.add('active');
    
    // Show appropriate form
    if (method === 'paypal') {
        document.getElementById('paypalForm').classList.remove('hidden');
        document.getElementById('cardForm').classList.add('hidden');
        renderPayPalButton();
    } else {
        document.getElementById('paypalForm').classList.add('hidden');
        document.getElementById('cardForm').classList.remove('hidden');
    }
}

function renderPayPalButton() {
    // Only render the button once
    if (paypalButtonRendered) return;
    
    const container = document.getElementById('paypal-button-container');
    container.innerHTML = '';
    
    paypal.Buttons({
        createOrder: function(data, actions) {
            const finalPrice = appliedDiscount ? 
                (pendingBooking.basePrice * (1 - appliedDiscount.percent / 100)).toFixed(2) : 
                pendingBooking.basePrice;
                
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: finalPrice
                    }
                }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                // Payment successful
                const finalPrice = appliedDiscount ? 
                    (pendingBooking.basePrice * (1 - appliedDiscount.percent / 100)).toFixed(2) : 
                    pendingBooking.basePrice;
                
                const newBooking = { 
                    id: Date.now(), 
                    venueId: currentVenueId, 
                    venue: pendingBooking.venue,
                    playerName: pendingBooking.playerName, 
                    date: pendingBooking.date, 
                    time: pendingBooking.time, 
                    basePrice: pendingBooking.basePrice,
                    finalPrice: parseFloat(finalPrice),
                    discountCode: appliedDiscount ? appliedDiscount.code : null,
                    paymentMethod: 'paypal', 
                    paymentStatus: 'confirmed',
                    paymentId: details.id,
                    createTime: details.create_time
                };
                
                db.allBookings.push(newBooking); 
                saveData(db);
                
                // Show success message
                document.getElementById('paymentMessage').textContent = 'تم تأكيد الدفع بنجاح! حجزك مؤكد الآن.';
                document.getElementById('paymentMessage').className = 'message success';
                document.getElementById('paymentMessage').classList.remove('hidden');
                
                // Reset state
                paypalButtonRendered = false;
                appliedDiscount = null;
                
                // Redirect to confirmation page after delay
                setTimeout(() => {
                    showPage('playerInterface');
                }, 3000);
            });
        },
        onError: function(err) {
            console.error('PayPal error:', err);
            document.getElementById('paymentMessage').textContent = 'حدث خطأ أثناء معالجة الدفع. يرجى المحاولة مرة أخرى.';
            document.getElementById('paymentMessage').className = 'message error';
            document.getElementById('paymentMessage').classList.remove('hidden');
        },
        onCancel: function(data) {
            document.getElementById('paymentMessage').textContent = 'تم إلغاء عملية الدفع.';
            document.getElementById('paymentMessage').className = 'message error';
            document.getElementById('paymentMessage').classList.remove('hidden');
        }
    }).render('#paypal-button-container');
    
    paypalButtonRendered = true;
}

function applyDiscountCode() {
    const codeInput = document.getElementById('discountCodeInput');
    const code = codeInput.value.trim().toUpperCase();
    
    if (!code) {
        showNotification('يرجى إدخال كود الخصم', 'error');
        return;
    }
    
    // Find the discount code in the database
    const discount = db.discountCodes.find(d => d.code === code);
    
    if (!discount) {
        document.getElementById('discountMessage').textContent = 'كود الخصم غير صالح';
        document.getElementById('discountMessage').style.color = 'var(--accent-color)';
        document.getElementById('discountMessage').style.display = 'block';
        return;
    }
    
    // Apply the discount
    appliedDiscount = discount;
    
    // Update the payment summary
    updatePaymentSummary();
    
    // Show success message
    document.getElementById('discountMessage').textContent = `تم تطبيق خصم ${discount.percent}% بنجاح!`;
    document.getElementById('discountMessage').style.color = 'var(--secondary-color)';
    document.getElementById('discountMessage').style.display = 'block';
    
    // Re-render PayPal button with new price
    paypalButtonRendered = false;
    renderPayPalButton();
}

function updatePaymentSummary() {
    if (!pendingBooking) return;
    
    const basePrice = pendingBooking.basePrice;
    let discountAmount = 0;
    let finalPrice = basePrice;
    
    if (appliedDiscount) {
        discountAmount = basePrice * (appliedDiscount.percent / 100);
        finalPrice = basePrice - discountAmount;
        
        document.getElementById('summaryDiscountRow').style.display = 'flex';
        document.getElementById('summaryDiscount').textContent = `${discountAmount.toFixed(2)} ريال (${appliedDiscount.percent}%)`;
    } else {
        document.getElementById('summaryDiscountRow').style.display = 'none';
    }
    
    document.getElementById('summaryBasePrice').textContent = `${basePrice} ريال`;
    document.getElementById('summaryTotalPrice').textContent = `${finalPrice.toFixed(2)} ريال`;
}

// Credit card form submission
document.getElementById('creditCardForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // In a real implementation, you would process the credit card payment here
    // For this demo, we'll simulate a successful payment
    
    const finalPrice = appliedDiscount ? 
        (pendingBooking.basePrice * (1 - appliedDiscount.percent / 100)).toFixed(2) : 
        pendingBooking.basePrice;
    
    const newBooking = { 
        id: Date.now(), 
        venueId: currentVenueId, 
        venue: pendingBooking.venue,
        playerName: pendingBooking.playerName, 
        date: pendingBooking.date, 
        time: pendingBooking.time, 
        basePrice: pendingBooking.basePrice,
        finalPrice: parseFloat(finalPrice),
        discountCode: appliedDiscount ? appliedDiscount.code : null,
        paymentMethod: 'credit_card', 
        paymentStatus: 'confirmed',
        paymentId: 'card_' + Date.now()
    };
    
    db.allBookings.push(newBooking); 
    saveData(db);
    
    // Show success message
    document.getElementById('paymentMessage').textContent = 'تم تأكيد الدفع بنجاح! حجزك مؤكد الآن.';
    document.getElementById('paymentMessage').className = 'message success';
    document.getElementById('paymentMessage').classList.remove('hidden');
    
    // Reset state
    appliedDiscount = null;
    
    // Redirect to confirmation page after delay
    setTimeout(() => {
        showPage('playerInterface');
    }, 3000);
});

// --- Chat Functions ---
function loadChatMessages(bookingId, userType) {
    const messagesContainer = userType === 'admin' ? document.getElementById('adminChatMessages') : document.getElementById('chatMessages');
    messagesContainer.innerHTML = '';
    const messages = db.chatMessages.filter(m => m.bookingId === bookingId);
    if (messages.length === 0) { 
        const welcomeMsg = { 
            sender: 'admin', 
            text: 'مرحباً! يرجى إرسال صورة تأكيد الدفع لتأكيد حجزك.', 
            timestamp: Date.now() 
        }; 
        db.chatMessages.push({ ...welcomeMsg, bookingId }); 
        saveData(db); 
        messages.push(welcomeMsg); 
    }
    messages.forEach(msg => displayMessage(msg, messagesContainer));
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function displayMessage(msg, container) {
    const messageDiv = document.createElement('div'); 
    messageDiv.className = `message-bubble ${msg.sender}`;
    let content = `<p>${msg.text}</p>`; 
    if (msg.imageUrl) { 
        content += `<img src="${msg.imageUrl}" alt="صورة تأكيد الدفع">`; 
    }
    messageDiv.innerHTML = content; 
    container.appendChild(messageDiv);
}

function sendMessage() {
    const input = document.getElementById('chatInput'); 
    const text = input.value.trim();
    if (!text || !currentPendingBookingId) return;
    
    const message = { 
        bookingId: currentPendingBookingId, 
        sender: 'user', 
        text: text, 
        timestamp: Date.now() 
    };
    db.chatMessages.push(message); 
    saveData(db);
    displayMessage(message, document.getElementById('chatMessages'));
    input.value = ''; 
    document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
}

function sendImage(event) {
    const file = event.target.files[0]; 
    if (!file || !currentPendingBookingId) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const message = { 
            bookingId: currentPendingBookingId, 
            sender: 'user', 
            text: 'تم إرسال صورة تأكيد الدفع.', 
            imageUrl: e.target.result, 
            timestamp: Date.now() 
        };
        db.chatMessages.push(message); 
        saveData(db);
        displayMessage(message, document.getElementById('chatMessages'));
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        addNotification(`تم إرسال صورة تأكيد الدفع لحجز #${currentPendingBookingId}`);
    };
    reader.readAsDataURL(file); 
    event.target.value = '';
}

function showAdminChat(bookingId) { 
    currentPendingBookingId = bookingId; 
    showPage('adminChatPage'); 
}

function confirmBookingFromChat() {